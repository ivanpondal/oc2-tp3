\subsection{Paginación básica}

Aquí contaremos los pasos necesarios para poder activar la paginación y que esta
esté configurada para realizar \textit{identity mapping}. Este término se
utiliza para describir un direccionamiento de memoria donde la dirección virtual
coincide uno a uno con la física.

Las páginas que definimos nos mapean las direcciones
\texttt{0x00000000} a \texttt{0x003FFFFF}, el directorio de páginas se encuentra
en la dirección \texttt{0x27000} y la tabla de páginas en \texttt{0x28000}.

\subsubsection{Rutinas de mapeado y desmapeado}

Escribimos dos rutinas para realizar la tarea, la de mapeado que nos permite
asociar una dirección virtual con una física, y la de desmapeado que dada una
dirección virtual la desasocia de memoria.

\subsubsection*{Mapeado}

La función \texttt{mmu\_mapear\_pagina} toma como parámetros la dirección \texttt{virtual}, el contenido del
registro \texttt{cr3}, la dirección \texttt{física} y por último los atributos
\texttt{attrs}.

\begin{enumerate}
	\item Extraemos la dirección del directorio de tablas de \texttt{cr3}.
	\begin{lstlisting}
	base_directorio_tablas = 0xFFFFF000 AND cr3
	\end{lstlisting}

	\item Calculamos el offset dentro del directorio de tablas en base a
	\texttt{virtual}.
	\begin{lstlisting}
	offset_directorio_tablas = ((0xFFC00000 AND virtual) >> 22) << 2
	\end{lstlisting}

	\item Obtenemos el Page Directory Entry correspondiente.
	\begin{lstlisting}
	pde = *(base_directorio_tablas + offset_directorio_tablas)
	\end{lstlisting}

	\item Extraemos la dirección del directorio de páginas de \texttt{pde}.
	\begin{lstlisting}
	base_directorio_paginas = 0xFFFFF000 AND pde
	\end{lstlisting}

	\item Calculamos el offset dentro del directorio de páginas en base a
	\texttt{virtual}.
	\begin{lstlisting}
	offset_directorio_paginas = ((0x003FF000 AND virtual) >> 12) << 2
	\end{lstlisting}

	\item Obtenemos el puntero al Page Table Entry correspondiente.
	\begin{lstlisting}
	ptr_pte = base_directorio_paginas + offset_directorio_paginas
	\end{lstlisting}

	\item Asignamos al Page Table Entry la dirección de la \texttt{física} y los
	atributos \texttt{attrs}.
	\begin{lstlisting}
	*ptr_pte = (0xFFFFF000 AND fisica) OR attrs
	\end{lstlisting}
\end{enumerate}

\subsubsection*{Desmapeado}

La función \texttt{mmu\_unmapear\_pagina} toma como parámetros la dirección
\texttt{virtual} y el contenido del registro \texttt{cr3}. Los primeros 6 pasos
serán idénticos a los de \texttt{mmu\_mapear\_pagina}.

\begin{enumerate}
	\setcounter{enumi}{6}
	\item Seteamos en el Page Table Entry el bit de \texttt{present} en 0.
	\begin{lstlisting}
	*ptr_pte = *ptr_pte AND 0xFFFFFFFE
	\end{lstlisting}
\end{enumerate}

\subsubsection{Generación del directorio de páginas}

Para mapear las direcciones solicitadas, desarrollamos la función
\texttt{mmu\_inicializar\_dir\_kernel} que se encarga de generar la primer
entrada en el directorio de tablas y su tabla de páginas asociada.

\begin{enumerate}
	\item Primero creamos nuestro Page Directory Entry en la dirección
		\texttt{0x27000}.
	\begin{lstlisting}
	ptr_pde = 0x27000
	*ptr_pde = 0 // Limpiamos la entrada
	*ptr_pde = *ptr_pde OR 0x3 // Asignamos atributos
	\end{lstlisting}
	El número \texttt{0x3} equivale en binario a \texttt{11}. Estos dos primeros
	bits encendidos corresponden dentro del Page Directory Entry a que el
	directorio de páginas estará presente y que además podrá ser leído y
	escrito.
	\begin{lstlisting}
	*ptr_pde = *ptr_pde OR 0x28000 // Asignamos direccion
	\end{lstlisting}

	\item Llenamos el directorio de páginas aplicándole a cada entrada los
		mismos atributos descritos en el punto anterior.
	\begin{lstlisting}
	Para i de 0 a 1024
		direccion_pagina = i << 12
		mmu_mapear_pagina(direccion_pagina, 0x27000, direccion_pagina, 0x3)
	Fin para
	\end{lstlisting}
\end{enumerate}

\subsubsection{Activación de la paginación}

Finalmente, teniendo las rutinas explicadas previamente, procedimos a activar la
paginación en el procesador. El código siguiente corresponde a una sección del
kernel.

\begin{enumerate}
	\item Llamamos a nuestra rutina de inicialización del directorio de tablas
	\begin{lstlisting}
	call mmu_inicializar_dir_kernel
	\end{lstlisting}

	\item Cargamos la dirección del directorio de tablas en el registro
		\texttt{cr3}.
	\begin{lstlisting}
	mov eax, 0x00027000
	mov cr3, eax
	\end{lstlisting}

	\item Activamos la paginación encendiendo el bit más significativo del
		registro \texttt{cr0}.
	\begin{lstlisting}
	mov eax, cr0
	or eax, 0x80000000
	mov cr0, eax
	\end{lstlisting}
\end{enumerate}
